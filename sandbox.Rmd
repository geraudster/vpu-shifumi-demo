---
title: "An example Knitr/R Markdown document"
author: "Géraud Dugé de Bernonville"
date: "29 septembre 2018"
output: html_document
---

# Installation de Keras

Installation du package:

```{r,results='hide',message=FALSE,cache=TRUE}
devtools::install_github("rstudio/keras")
library(keras)
use_python("/usr/bin/python3")

install_keras()
```

Installation de tensorflow:

```{r,results='hide',message=FALSE,cache=TRUE}
library(reticulate)
py_install('pydot', envname = 'r-tensorflow')
```

```{r}
library(keras)
library(reticulate)
```

# Définition des constantes

```{r}
img_width <- 128
img_height <- 128
train_data_dir <-  "/home/geraud/data/alphashifumi/train"
validation_data_dir <-  "/home/geraud/data/alphashifumi/test"
nb_train_samples <-  4125
nb_validation_samples <-  466 
batch_size <-  50
epochs <-  50
```

# Keras training

Chargement du modèle MobileNet

```{r}
base_model <- application_inception_v3(weight = 'imagenet',
                                       include_top = FALSE,
                                       input_shape = c(img_width, img_height, 3))

```

On ajoute nos couches denses :

```{r}
predictions <- base_model$output %>%
    layer_global_average_pooling_2d() %>%
    layer_dense(units = 1024, activation = 'relu') %>%
#    layer_dropout(0.5) %>%
    layer_dense(units = 1024, activation = 'relu') %>%
    layer_dense(units = 1024, activation = 'relu') %>%
    layer_dense(units = 1024, activation = 'relu') %>%
    layer_dense(units = 5) %>%
    layer_activation(activation = 'softmax')

```

Le nouveau modèle à entrainer devient :
```{r}
model <- keras_model(inputs = base_model$input, outputs = predictions)
```

On _freeze_ toutes les couches, pas besoin de les réentrainer :

```{r}
for (layer in base_model$layers)
  layer$trainable <- FALSE
#freeze_weights(base_model)
```

On _compile_ le modèle :

```{r}
model %>% compile(optimizer = 'rmsprop',
                  loss = 'categorical_crossentropy',
                  metrics = c('accuracy'))
```

Notre nouveau modèle ressemble à ça :

```{r}
summary(model)
```
# Chargement des données

On configure les générateurs:
```{r}
train_datagen <- image_data_generator(
    rescale = 1./255,
    horizontal_flip = TRUE,
    fill_mode = "nearest",
    zoom_range = 0.3,
    width_shift_range = 0.3,
    height_shift_range = 0.3,
    rotation_range = 30,
    data_format = 'channels_last')

test_datagen <- image_data_generator(
    rescale = 1./255,
    horizontal_flip = TRUE,
    fill_mode = "nearest",
    zoom_range = 0.3,
    width_shift_range = 0.3,
    height_shift_range = 0.3,
    rotation_range = 30,
    data_format = 'channels_last')

```

Chargement des images:

```{r}
train_generator <- flow_images_from_directory(
    train_data_dir,
    generator = train_datagen,
    target_size = c(img_height, img_width),
    batch_size = batch_size, 
    class_mode = "categorical",
    save_to_dir = 'generated')

validation_generator <- flow_images_from_directory(
    validation_data_dir,
    generator = train_datagen,
    target_size = c(img_height, img_width),
    class_mode = "categorical")

```

# Entrainement !

```{r}
history <- model %>% fit_generator(train_generator,
                                   validation_data = validation_generator,
                                   steps_per_epoch = 5,
                                   validation_steps = 10,
                                   epochs = 5)

```

On peut surveiller la courbe d'apprentissage :

```{r}
plot(history)
```

# Sauvegarde du modèle

```{r}
#export_savedmodel(model, 'output/model_weights')
save_model_hdf5(model, 'output/model_hdf5')
```

```{r}
export_savedmodel(model, 'output/export/')
```

# Freeze du modèle

```{r}
library(keras)
library(tensorflow)

k_clear_session()
model <- load_model_hdf5('output/model_hdf5')
k_set_learning_phase(0)

library(tensorflow)
model$input_names
model$output_names
model$output[1]$name

sess <- k_get_session()

optimized_graph <- sess$graph$as_graph_def()
#optimized_graph <- tf$graph_util$remove_training_nodes(optimized_graph)
optimized_graph <- tf$graph_util$convert_variables_to_constants(sess, optimized_graph, list('strided_slice'))

tf$train$write_graph(optimized_graph, 'frozen-orig', 'retrained.pb', as_text=FALSE)
tf$train$write_graph(optimized_graph, 'frozen-orig', 'retrained.txt', as_text=TRUE)
```

# Compilation vers le NCS

```{bash}
docker run -v $PWD/frozen-orig/retrained.pb:/model.pb -it geraudster/ncs-container mvNCCompile /model.pb -in 'input_1' -on 'activation_1/Softmax'
```
